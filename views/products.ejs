<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - Rate & Review</title>
    <link rel="stylesheet" href="/css/main.css">
    <style>
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Product Rating System</h1>
            <p>Rate your favorite products and see what others think!</p>
        </div>
        
        <%- include('partials/navbar') %>
        
        <div class="content">
            <!-- Success/Error Messages -->
            <% 
            const urlParams = new URLSearchParams(typeof window !== 'undefined' ? window.location.search : '');
            if (typeof URLSearchParams !== 'undefined') {
                // Handle URL parameters for messages
            }
            %>
            
            <script>
                // Handle URL parameters for success/error messages
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('success') === 'ratings_saved') {
                    document.write('<div class="alert success">âœ“ Your ratings have been saved successfully!</div>');
                } else if (urlParams.get('error') === 'no_ratings') {
                    document.write('<div class="alert error">âš  Please select at least one rating before submitting.</div>');
                } else if (urlParams.get('error') === 'save_failed') {
                    document.write('<div class="alert error">âš  Failed to save ratings. Please try again.</div>');
                } else if (urlParams.get('error') === 'access_denied') {
                    document.write('<div class="alert error">âš  Access denied. Admin privileges required.</div>');
                }
            </script>
            
            <form action="/submit_ratings" method="post">
                <div class="products-grid">
                    <% if (products && products.length > 0) { %>
                        <% products.forEach(function(product, index) { %>
                            <div class="product-card">
                                <img src="<%= product.image_url %>" alt="<%= product.name %>" class="product-image" onerror="this.src='https://via.placeholder.com/300x200?text=Product+Image'">
                                
                                <div class="product-name"><%= product.name %></div>
                                <div class="product-description"><%= product.description %></div>
                                
                                <div class="rating-info">
                                    <div>
                                        <% 
                                        const avgRating = avgRatings ? avgRatings.find(r => r.product_id == product.id) : null;
                                        const avgScore = avgRating ? parseFloat(avgRating.avg_rating).toFixed(1) : 'No ratings';
                                        const totalRatings = avgRating ? avgRating.total_ratings : 0;
                                        %>
                                        <div class="avg-rating">
                                            Average: <%= avgScore %>
                                            <% if (avgRating) { %>
                                                <span class="stars">
                                                    <% for (let i = 1; i <= 5; i++) { %>
                                                        <%= i <= Math.round(avgRating.avg_rating) ? 'â˜…' : 'â˜†' %>
                                                    <% } %>
                                                </span>
                                            <% } %>
                                        </div>
                                        <small>(<%= totalRatings %> ratings)</small>
                                    </div>
                                </div>
                                
                                <% 
                                const userRating = userRatings ? userRatings.find(r => r.product_id == product.id) : null;
                                %>
                                <% if (userRating) { %>
                                    <div class="current-rating">
                                        Your current rating: <%= userRating.rating %>/5 â˜…
                                    </div>
                                <% } %>
                                
                                <select class="rating-select" name="rating_product<%= product.id %>" id="product<%= product.id %>">
                                    <option value="">Select rating</option>
                                    <option value="1" <%= userRating && userRating.rating == 1 ? 'selected' : '' %>>1 - Poor</option>
                                    <option value="2" <%= userRating && userRating.rating == 2 ? 'selected' : '' %>>2 - Fair</option>
                                    <option value="3" <%= userRating && userRating.rating == 3 ? 'selected' : '' %>>3 - Good</option>
                                    <option value="4" <%= userRating && userRating.rating == 4 ? 'selected' : '' %>>4 - Very Good</option>
                                    <option value="5" <%= userRating && userRating.rating == 5 ? 'selected' : '' %>>5 - Excellent</option>
                                </select>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="product-card">
                            <p>No products available. Please contact administrator.</p>
                        </div>
                    <% } %>
                </div>
                
                <div class="submit-section">
                    <button type="submit" class="submit-btn">Submit Ratings</button>
                </div>
            </form>
            
            <div class="admin-link">
                <a href="/dashboard">ðŸ“Š View Dashboard (Admin Only)</a>
            </div>
        </div>
    </div>
</body>
</html>